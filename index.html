<!DOCTYPE html>
<html>
<head>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    #infoDrawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      height: 0;
      overflow: auto;
      transition: height 0.5s ease;
    }
    #infoDrawer.open {
      height: 50%; /* Adjust height to control how much it covers */
    }
    #infoDrawer.full {
      height: 100%;
    }
    #infoContent {
      padding: 20px;
    }
    #toggleButton {
      display: block;
      padding: 10px;
      text-align: center;
      background: #f0f0f0;
      cursor: pointer;
    }
    .tabs-container {
      display: flex;
      background: #eee;
      padding: 5px;
    }
    .tab {
      padding: 10px;
      cursor: pointer;
    }
    #cameraSelector, #aspectRatioSelector {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
    #aspectRatioSelector {
      top: 50px;
    }
    #cameraInfoViewer {
      position: fixed;
      top: 500px;
      padding: 20px;
      left: 0;
      right: 0;
      overflow: auto;
      background: #f0f0f0;
    }

    #reloadButton {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: #f0f0f0;
      padding: 10px;
      cursor: pointer;
    }
    #zoomButtons {
      position: fixed;
      top: 90px;
      right: 10px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
    }
    .zoomButton {
      margin: 5px;
      padding: 10px;
      background: #f0f0f0;
      cursor: pointer;
    }
    .arjs-loader {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .arjs-loader div {
      text-align: center;
      font-size: 1.25em;
      color: white;
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden">
  <div class="arjs-loader">
    <div>Loading, please wait...</div>
  </div>
  <a-scene vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true;" embedded arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
    <a-nft type="nft" url="data/wounded_angel/wounded_angel" tag="Wounded_Angel" tag_id="wounded_angel01" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/resurrection/the_resurrection" tag="Resurrection" tag_id="resurrection01" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <!-- <a-nft type="nft" url="data/resurrection/the_resurrection2" tag="resurrection" tag_id="resurrection02" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft> -->
    <!-- <a-nft type="nft" url="data/resurrection/the_resurrection3" tag="resurrection" tag_id="resurrection03" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft> -->
    <a-nft type="nft" url="data/glass1/glass_1_1" tag="StainedGlass_1" tag_id="glass_1_1" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/glass2/glass_2_3" tag="StainedGlass_2" tag_id="glass_2_3" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/glass2/glass_2_2" tag="StainedGlass_2" tag_id="glass_2_2" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/glass3/glass_3_2" tag="StainedGlass_3" tag_id="glass_3_2" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/glass4/glass_4_2" tag="StainedGlass_4" tag_id="glass_4_2" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/glass5/glass_5_1" tag="StainedGlass_5" tag_id="glass_5_1" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/glass6/glass_6_1" tag="StainedGlass_6" tag_id="glass_6_1" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/garden_of_death/garden_of_death" tag="Garden_Of_Death" tag_id="garden_of_death01" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/pipe_organ/pipe_organ" tag="Organ" tag_id="pipe_organ01" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <!-- <a-nft type="nft" url="data/serpent/serpent" tag="serpent" tag_id="serpent_0" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft> -->
    <a-nft type="nft" url="data/serpent/serpent1" tag="Serpent" tag_id="serpent_1" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/serpent/serpent2" tag="Serpent" tag_id="serpent_2" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/serpent/serpent3" tag="Serpent" tag_id="serpent_3" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-nft type="nft" url="data/serpent/serpent4" tag="Serpent" tag_id="serpent_4" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <!-- <a-nft type="nft" url="data/serpent/serpent5" tag="serpent" tag_id="serpent_5" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft> -->
    <a-nft type="nft" url="data/serpent/serpent6" tag="Serpent" tag_id="serpent_6" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-nft>
    <a-marker preset="hiro" tag="garden_of_death"></a-marker>
    <a-marker preset="kanji"></a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <div id="infoDrawer">
    <div id="toggleButton">Tap here for more information</div>
    <div id="tabsContainer" class="tabs-container"></div>
    <div id="infoContent">Information will be loaded here</div>
  </div>

  <!-- <div id="cameraInfoViewer"></div> -->
  <select id="cameraSelector"></select>
  <div id="zoomButtons">
    <div class="zoomButton" data-zoom="1">1x</div>
    <div class="zoomButton" data-zoom="2">2x</div>
    <div class="zoomButton" data-zoom="5">5x</div>
  </div>
  <div id="reloadCameraButton" style="position: fixed; top: 10px; right: 10px; z-index: 1000; text-align: right;">
    <div style="margin-bottom: 2px;"><button onclick="reloadCamera('480p')">Reload Camera 480p</button></div>
    <div style="margin-bottom: 2px;"><button onclick="reloadCamera('720p')">Reload Camera 720p</button></div>
    <div><button onclick="reloadCamera('1080p')">Reload Camera 1080p</button></div>
  </div>

  <script>
    let currentStream;

    async function initCamera(deviceId, resolution) {
      console.log('Initializing camera with deviceId:', deviceId);
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      console.log('Camera stopped');
      
      let constraints = {
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: { exact: 'environment' }, // Ensure we request the back camera
          aspectRatio: { ideal: 16/9},
        }
      };

      switch (resolution) {
        case '720p':
          constraints.video.width = { min: 1280, ideal: 1280, max: 1920 };
          constraints.video.height = { min: 720, ideal: 720, max: 1080 };
          break;
        case '1080p':
          constraints.video.width = { min: 1920, ideal: 1920, max: 1920 };
          constraints.video.height = { min: 1080, ideal: 1080, max: 1080 };
          break;
        case '480p':
        default:
          constraints.video.width = { min: 640, ideal: 640, max: 1280 };
          constraints.video.height = { min: 480, ideal: 480, max: 720 };
          break;
      }
      console.log('Trying to initialize camera with constraints:', constraints);
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log('Camera initialized with the provided constraints');
      } catch (error) {
        console.error('Could not initialize camera with the provided constraints:', error);
        // Relax the constraints and try again
        constraints = {
          video: {
            deviceId: deviceId ? { exact: deviceId } : undefined,
            aspectRatio: { ideal: 16/9},
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
          }
        };
        try {
          currentStream = await navigator.mediaDevices.getUserMedia(constraints);
          console.log('Camera initialized with the provided constraints');
        } catch (error) {
          console.error('Could not initialize camera with the relaxed constraints:', error);
          return;
        }
      }

      const videoTracks = currentStream.getVideoTracks();
      const videoTrack = videoTracks[0];
      
      const capabilities = videoTrack.getCapabilities();
      const settings = videoTrack.getSettings();

      if (capabilities.exposureMode) {
        videoTrack.applyConstraints({ advanced: [{ exposureMode: 'continuous' }] });
      }

      const video = document.querySelector('#arjs-video');
      video.srcObject = currentStream;
    }

    document.getElementById('infoDrawer').addEventListener('transitionend', function() {
      var drawer = document.getElementById('infoDrawer');
      var isFull = drawer.classList.contains('full'); // replace this with your own condition
      document.getElementById('cameraSelector').style.display = isFull ? 'none' : 'block';
      document.getElementById('zoomButtons').style.display = isFull ? 'none' : 'block';
      document.getElementById('reloadCameraButton').style.display = isFull ? 'none' : 'block';
    });
    function reloadCamera(resolution) {
      const cameraSelector = document.getElementById('cameraSelector');
      if (cameraSelector.length > 0) {
        initCamera(cameraSelector.value, resolution);
      }
    }

    // Update aspect ratios when camera is selected
    document.getElementById('cameraSelector').addEventListener('change', async (event) => {
      await initCamera(event.target.value, '480p');
    });

    async function populateCameraOptions() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      const cameraSelector = document.getElementById('cameraSelector');
      cameraSelector.innerHTML = '';
      videoDevices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Camera ${cameraSelector.length + 1}`;
        cameraSelector.appendChild(option);
      });

      // Automatically select the back camera if available
      const backCamera = videoDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear'));
      if (backCamera) {
        cameraSelector.value = backCamera.deviceId;
      }
    }
    // Handle zoom buttons
    document.querySelectorAll('.zoomButton').forEach(button => {
      button.addEventListener('click', () => {
        const zoomLevel = Number(button.getAttribute('data-zoom'));
        const videoTracks = currentStream.getVideoTracks();
        const videoTrack = videoTracks[0];
        const capabilities = videoTrack.getCapabilities();
        
        if (capabilities.zoom) {
          videoTrack.applyConstraints({ advanced: [{ zoom: zoomLevel }] });
        }
        // updateCameraInfo();
      });
    });
  
    // Initialize on page load
    window.addEventListener('load', async () => {
        await populateCameraOptions();
        const cameraSelector = document.getElementById('cameraSelector');
        if (cameraSelector.length > 0) {
          initCamera(cameraSelector.value);
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
      const markersActive = {};
      const tagTimeouts = {};
      document.querySelectorAll("a-nft").forEach((marker) => {
        const tag = marker.getAttribute("tag");
        const tagId = marker.getAttribute("tag_id");
        marker.addEventListener("markerFound", function () {
          if (!markersActive[tag]) {
            markersActive[tag] = {
              elements: [],
              lastDetected: Date.now(),
              detectedOrder: []
            };
          }
          markersActive[tag].elements.push(marker);
          markersActive[tag].lastDetected = Date.now();
          markersActive[tag].detectedOrder.push(tagId);

          updateTabs();
          showContent(tag); // Update content when new tag is detected
        });

        marker.addEventListener("markerLost", function () {
          setTimeout(() => {
            if (Date.now() - markersActive[tag].lastDetected >= 2000) {
              markersActive[tag].elements = markersActive[tag].elements.filter(m => m !== marker);
              markersActive[tag].detectedOrder = markersActive[tag].detectedOrder.filter(id => id !== tagId);
              if (markersActive[tag].elements.length === 0) {
                if (!document.getElementById("infoDrawer").classList.contains('full')) {
                  delete markersActive[tag];
                  updateTabs();
                } else {
                  // tagTimeouts[tag] = setTimeout(() => {
                    delete markersActive[tag];
                    // updateTabs();
                  // }, 2000); // Additional timeout if drawer is in full state
                }
              }
            }
          }, 2000);
        });
      });

      const toggleButton = document.getElementById("toggleButton");
      toggleButton.addEventListener('click', function () {
        const drawer = document.getElementById("infoDrawer");
        if (drawer.classList.contains('full')) {
          // Check if any marker is there. If not, close the drawer
          if (Object.keys(markersActive).length === 0) {
            drawer.classList.remove('open', 'full');
          }
        }
        if (drawer.classList.contains('open')) {
          drawer.classList.toggle('full');
        }
      });

      function updateTabs() {
        const tabsContainer = document.getElementById("tabsContainer");
        tabsContainer.innerHTML = ''; // Clear existing tabs

        Object.keys(markersActive).forEach(tag => {
          const tab = document.createElement('div');
          tab.className = 'tab';
          tab.textContent = tag; // Using tag as tab title
          tab.onclick = () => showContent(tag);
          tabsContainer.appendChild(tab);
        });

        if (Object.keys(markersActive).length > 0) {
          document.getElementById("infoDrawer").classList.add("open");
        } else {
          document.getElementById("infoDrawer").classList.remove("open", "full");
        }
      }

      function showContent(tag) {
        const content = document.getElementById("infoContent");
        fetch(`details/${tag}.html`)
          .then(response => response.text())
          .then(data => {
            content.innerHTML = data;
          });
      }
    });

  </script>
</body>
</html>
